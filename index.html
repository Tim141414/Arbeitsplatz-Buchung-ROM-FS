<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Arbeitsplatz-Buchung (Tag & Woche)</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>

<style>
  body { background:#f4f6f8; color:#222; }
  h1 { font-weight:700; }
  .controls { margin-bottom:18px; }
  .room-card { background:#fff; border-radius:10px; padding:14px; box-shadow:0 2px 6px rgba(0,0,0,.04); margin-bottom:18px; }
  .desk { border:1px solid #e6e9ee; border-radius:8px; padding:10px; min-height:90px; background:#fbfdff; }
  .desk .label { font-weight:600; margin-bottom:6px; }
  .booking-pill { border-radius:6px; padding:6px 8px; margin-bottom:6px; display:block; font-size:0.9rem; }
  .booking-office { background:#e7f0ff; color:#04316a; }
  .booking-mobile { background:#e8f8ef; color:#0b6b3b; }
  .btn-book { margin-top:8px; }
  .calendar-table th, .calendar-table td { vertical-align:top; min-width:120px; }
  .day-header { font-weight:700; font-size:0.95rem; background:#fff; padding:10px; border-radius:6px; border:1px solid #eef2f6; text-align:center; }
  .small-muted { color:#6c757d; font-size:0.9rem; }
  .top-row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
  @media (max-width:900px) {
    .calendar-table th, .calendar-table td { min-width:100px; }
  }
</style>
</head>
<body>

<div class="container py-4">
  <h1 class="mb-3">Arbeitsplatz-Buchung</h1>

  <div class="controls d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-2">
      <label class="me-2 mb-0 small-muted">Ansicht:</label>
      <select id="viewSelect" class="form-select form-select-sm">
        <option value="day">Tagesansicht</option>
        <option value="week">Wochenansicht</option>
      </select>

      <button id="prevBtn" class="btn btn-primary btn-sm ms-3">← Zurück</button>
      <button id="nextBtn" class="btn btn-primary btn-sm">Weiter →</button>

      <label class="ms-3 small-muted mb-0">Datum:</label>
      <input id="datePicker" type="date" class="form-control form-control-sm ms-2" style="width:160px;" />
    </div>

    <div class="d-flex align-items-center gap-3">
      <div class="small-muted">Angemeldet als</div>
      <div><strong id="currentUser">-</strong></div>
      <button id="changeUserBtn" class="btn btn-outline-secondary btn-sm">Benutzer wechseln</button>
    </div>
  </div>

  <div id="contentArea"></div>

  <!-- Optional: eigene Buchungen -->
  <div id="myBookingsCard" class="card mt-3">
    <div class="card-body">
      <h5 class="card-title">Meine Buchungen</h5>
      <ul id="myBookingsList" class="list-group list-group-flush"></ul>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<script>
/* ================== Konfiguration ================== */
const firebaseConfig = {
  apiKey: "AIzaSyDAXAufUjDPTeGqEIArC10W3ZXKsf0an1w",
  authDomain: "arbeitsplatz--buchung.firebaseapp.com",
  projectId: "arbeitsplatz--buchung",
  storageBucket: "arbeitsplatz--buchung.firebasestorage.app",
  messagingSenderId: "1022648652918",
  appId: "1:1022648652918:web:067868ac0564810d5a7b57",
  measurementId: "G-FQ868CPKZ6"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================== Model / State ================== */
const ROOMS = [
  { id: 'room1', label: 'Raum 1', seats: 5 },
  { id: 'room2', label: 'Raum 2', seats: 4 },
  { id: 'mobile', label: 'Mobile Working', seats: 0, unlimited: true }
];

let currentUser = localStorage.getItem('currentUser') || '';
if (!currentUser) {
  currentUser = prompt('Bitte gib deinen Namen ein:') || 'Gast';
  localStorage.setItem('currentUser', currentUser);
}
document.getElementById('currentUser').textContent = currentUser;

document.getElementById('changeUserBtn').addEventListener('click', () => {
  const n = prompt('Name ändern (leer = abbruch):', currentUser);
  if (n && n.trim()) {
    currentUser = n.trim();
    localStorage.setItem('currentUser', currentUser);
    document.getElementById('currentUser').textContent = currentUser;
    render(); // refresh
  }
});

const viewSelect = document.getElementById('viewSelect');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const datePicker = document.getElementById('datePicker');
const contentArea = document.getElementById('contentArea');
const myBookingsList = document.getElementById('myBookingsList');

let currentBaseDate = new Date();
currentBaseDate.setHours(0,0,0,0);
datePicker.value = toISO(currentBaseDate);

viewSelect.addEventListener('change', () => { render(); });
datePicker.addEventListener('change', () => {
  const d = new Date(datePicker.value);
  if (!isNaN(d)) { currentBaseDate = d; render(); }
});
prevBtn.addEventListener('click', () => {
  if (viewSelect.value === 'day') currentBaseDate.setDate(currentBaseDate.getDate() - 1);
  else currentBaseDate.setDate(currentBaseDate.getDate() - 7);
  datePicker.value = toISO(currentBaseDate);
  render();
});
nextBtn.addEventListener('click', () => {
  if (viewSelect.value === 'day') currentBaseDate.setDate(currentBaseDate.getDate() + 1);
  else currentBaseDate.setDate(currentBaseDate.getDate() + 7);
  datePicker.value = toISO(currentBaseDate);
  render();
});

/* All bookings live */
let allBookings = []; // array of {id, date, roomId, seatId, startTime, endTime, user}

let unsubscribe = null;
function startListener(){
  if (unsubscribe) unsubscribe();
  unsubscribe = db.collection('bookings').onSnapshot(snap => {
    allBookings = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    render();
  }, err => console.error(err));
}
startListener();

/* ================== Helpers ================== */
function toISO(d){ return d.toISOString().slice(0,10); }
function parseISO(s){ return new Date(s + 'T00:00:00'); }
function pad(n){ return String(n).padStart(2,'0'); }
function timeToMinutes(t){ const [hh,mm]=t.split(':').map(Number); return hh*60+mm; }
function minutesToTime(m){ return pad(Math.floor(m/60))+':'+pad(m%60); }
function overlaps(aStart,aEnd,bStart,bEnd){
  return (aStart < bEnd) && (bStart < aEnd);
}
function getWeekDates(base){
  const day = base.getDay(); // 0..6 Sun..Sat
  const diff = base.getDate() - day + (day === 0 ? -6 : 1); // Monday
  const monday = new Date(base);
  monday.setDate(diff);
  const arr = [];
  for(let i=0;i<7;i++){
    const d = new Date(monday); d.setDate(monday.getDate()+i);
    arr.push(d);
  }
  return arr;
}

/* ================== Render ================== */
function render(){
  const view = viewSelect.value;
  // make sure datePicker reflects currentBaseDate
  datePicker.value = toISO(currentBaseDate);

  if (view === 'day') renderDayView(toISO(currentBaseDate));
  else renderWeekView(getWeekDates(currentBaseDate));

  renderMyBookings();
}

/* Day view */
function renderDayView(dateStr){
  contentArea.innerHTML = '';
  for (const room of ROOMS){
    const card = document.createElement('div');
    card.className = 'room-card';

    const headerRow = document.createElement('div');
    headerRow.className = 'd-flex justify-content-between align-items-center mb-3';
    headerRow.innerHTML = `<h5 class="mb-0">${room.label}</h5><div class="small-muted">${dateStr}</div>`;
    card.appendChild(headerRow);

    if (room.unlimited){
      // mobile row: list bookings for that date
      const list = document.createElement('div');
      const bookings = allBookings.filter(b => b.date===dateStr && b.roomId === room.id)
        .sort((a,b) => a.startTime.localeCompare(b.startTime));
      if (bookings.length === 0) {
        list.innerHTML = `<div class="small-muted">Keine mobilen Einträge.</div>`;
      } else {
        for (const bk of bookings){
          const el = document.createElement('div');
          el.className = 'booking-pill booking-mobile';
          el.textContent = `${bk.user} — ${bk.startTime}–${bk.endTime}`;
          if (bk.user === currentUser) {
            const btn = document.createElement('button');
            btn.className = 'btn btn-sm btn-outline-danger ms-2';
            btn.style.verticalAlign = 'middle';
            btn.textContent = 'Stornieren';
            btn.onclick = async () => { if(confirm('Stornieren?')){ await db.collection('bookings').doc(bk.id).delete(); } };
            el.appendChild(btn);
          }
          list.appendChild(el);
        }
      }
      const addBtn = document.createElement('button');
      addBtn.className = 'btn btn-primary btn-sm btn-book';
      addBtn.textContent = 'Mobile Arbeit buchen';
      addBtn.onclick = () => openBookingModal({date: dateStr, roomId: room.id, seatId: 'mobile'});
      card.appendChild(list);
      card.appendChild(addBtn);
    } else {
      // show seats in grid
      const row = document.createElement('div');
      row.className = 'row g-3';
      for (let s=1; s<=room.seats; s++){
        const col = document.createElement('div');
        col.className = 'col-6 col-md-3';
        const desk = document.createElement('div');
        desk.className = 'desk';
        desk.innerHTML = `<div class="label">Platz ${s}</div>`;
        // bookings for seat
        const seatBookings = allBookings.filter(b => b.date===dateStr && b.roomId===room.id && b.seatId === `platz${s}`)
          .sort((a,b) => a.startTime.localeCompare(b.startTime));
        if (seatBookings.length === 0){
          const free = document.createElement('div');
          free.className = 'small-muted';
          free.textContent = 'Keine Buchungen';
          desk.appendChild(free);
        } else {
          for(const bk of seatBookings){
            const el = document.createElement('div');
            el.className = 'booking-pill ' + (bk.roomId==='mobile' ? 'booking-mobile' : 'booking-office');
            el.innerHTML = `<span>${bk.user}</span> <div class="small-muted">${bk.startTime}–${bk.endTime}</div>`;
            if (bk.user === currentUser){
              const btn = document.createElement('button');
              btn.className = 'btn btn-sm btn-outline-danger ms-2';
              btn.textContent = 'Stornieren';
              btn.onclick = async () => { if(confirm('Stornieren?')) await db.collection('bookings').doc(bk.id).delete(); };
              el.appendChild(btn);
            }
            desk.appendChild(el);
          }
        }
        const btn = document.createElement('button');
        btn.className = 'btn btn-outline-primary btn-sm btn-book';
        btn.textContent = 'Buchen';
        btn.onclick = () => openBookingModal({date: dateStr, roomId: room.id, seatId: `platz${s}`});
        desk.appendChild(btn);
        col.appendChild(desk);
        row.appendChild(col);
      }
      card.appendChild(row);
    }
    contentArea.appendChild(card);
  }
}

/* Week view (calendar-style columns) */
function renderWeekView(dates){
  // dates is array of Date objects (Mon..Sun)
  contentArea.innerHTML = '';

  // header row with days
  const headerCard = document.createElement('div');
  headerCard.className = 'room-card';
  const headerRow = document.createElement('div');
  headerRow.className = 'd-flex';
  for (let d of dates){
    const dayDiv = document.createElement('div');
    dayDiv.className = 'flex-fill text-center day-header';
    dayDiv.style.marginRight = '8px';
    dayDiv.innerHTML = `<div style="font-weight:700">${d.toLocaleDateString('de-DE',{weekday:'short'})}</div><div class="small-muted">${toISO(d)}</div>`;
    headerRow.appendChild(dayDiv);
  }
  headerCard.appendChild(headerRow);
  contentArea.appendChild(headerCard);

  // For each room render a grid row where each column is a day
  for (const room of ROOMS){
    const roomCard = document.createElement('div');
    roomCard.className = 'room-card';
    const roomTitle = document.createElement('h5');
    roomTitle.textContent = room.label;
    roomCard.appendChild(roomTitle);

    // Create table: first column is seat label (for mobile it's single row)
    const table = document.createElement('table');
    table.className = 'table calendar-table table-sm';
    const thead = document.createElement('thead');
    const trHead = document.createElement('tr');
    trHead.innerHTML = `<th style="width:140px">Platz</th>` + dates.map(d => `<th style="min-width:120px">${d.toLocaleDateString('de-DE',{weekday:'short','day':'2-digit','month':'2-digit'})}</th>`).join('');
    thead.appendChild(trHead);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');

    if (room.unlimited){
      // single row for mobile
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><strong>Mobile Working</strong></td>`;
      dates.forEach((d, idx) => {
        const td = document.createElement('td');
        const dateStr = toISO(d);
        const bookings = allBookings.filter(b => b.date===dateStr && b.roomId===room.id)
          .sort((a,b) => a.startTime.localeCompare(b.startTime));
        if (bookings.length === 0){
          td.innerHTML = `<div class="small-muted">Keine</div><button class="btn btn-sm btn-primary mt-2" onclick="openBookingModal({date:'${dateStr}', roomId:'${room.id}', seatId:'mobile'})">Buchen</button>`;
        } else {
          for (const bk of bookings){
            const el = document.createElement('div');
            el.className = 'booking-pill booking-mobile';
            el.textContent = `${bk.user} — ${bk.startTime}–${bk.endTime}`;
            if (bk.user === currentUser){
              const btn = document.createElement('button');
              btn.className = 'btn btn-sm btn-outline-danger ms-2';
              btn.textContent = 'Stornieren';
              btn.onclick = async () => { if(confirm('Stornieren?')) await db.collection('bookings').doc(bk.id).delete(); };
              el.appendChild(btn);
            }
            td.appendChild(el);
          }
          const add = document.createElement('button');
          add.className = 'btn btn-sm btn-primary mt-2';
          add.textContent = 'Buchen';
          add.onclick = () => openBookingModal({date: dateStr, roomId: room.id, seatId: 'mobile'});
          td.appendChild(add);
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    } else {
      // rows for each seat
      for (let s=1; s<=room.seats; s++){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><strong>Platz ${s}</strong></td>`;
        for (let d of dates){
          const td = document.createElement('td');
          const dateStr = toISO(d);
          const seatId = `platz${s}`;
          const bookings = allBookings.filter(b => b.date===dateStr && b.roomId===room.id && b.seatId===seatId)
            .sort((a,b) => a.startTime.localeCompare(b.startTime));
          if (bookings.length === 0){
            td.innerHTML = `<div class="small-muted">Frei</div><button class="btn btn-sm btn-outline-primary mt-2" onclick="openBookingModal({date:'${dateStr}', roomId:'${room.id}', seatId:'${seatId}'})">Buchen</button>`;
          } else {
            for (const bk of bookings){
              const el = document.createElement('div');
              el.className = 'booking-pill booking-office';
              el.innerHTML = `<span>${bk.user}</span> <div class="small-muted">${bk.startTime}–${bk.endTime}</div>`;
              if (bk.user === currentUser){
                const btn = document.createElement('button');
                btn.className = 'btn btn-sm btn-outline-danger ms-2';
                btn.textContent = 'Stornieren';
                btn.onclick = async () => { if(confirm('Stornieren?')) await db.collection('bookings').doc(bk.id).delete(); };
                el.appendChild(btn);
              }
              td.appendChild(el);
            }
            const add = document.createElement('button');
            add.className = 'btn btn-sm btn-outline-primary mt-2';
            add.textContent = 'Neu';
            add.onclick = () => openBookingModal({date: dateStr, roomId: room.id, seatId: `platz${s}`});
            td.appendChild(add);
          }
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
    }

    table.appendChild(tbody);
    roomCard.appendChild(table);
    contentArea.appendChild(roomCard);
  }
}

/* ================== Booking Modal & logic ================== */
function openBookingModal({date, roomId, seatId, preStart='08:00', preEnd='17:00'}) {
  // Build modal DOM (Bootstrap)
  const modalId = 'bookingModal';
  const old = document.getElementById(modalId);
  if (old) old.remove();
  const div = document.createElement('div');
  div.id = modalId;
  div.className = 'modal fade';
  div.tabIndex = -1;
  div.innerHTML = `
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="bookingForm">
          <div class="modal-header">
            <h5 class="modal-title">Buchen — ${roomId === 'mobile' ? 'Mobile Arbeit' : roomId + ' / ' + seatId}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2"><strong>Datum:</strong> ${date}</div>
            <div class="mb-3">
              <label class="form-label">Name</label>
              <input id="bookUser" class="form-control" type="text" value="${currentUser}" required />
            </div>
            <div class="row g-2">
              <div class="col">
                <label class="form-label">Start (HH:MM)</label>
                <input id="bookStart" type="time" class="form-control" value="${preStart}" required />
              </div>
              <div class="col">
                <label class="form-label">Ende (HH:MM)</label>
                <input id="bookEnd" type="time" class="form-control" value="${preEnd}" required />
              </div>
            </div>
            <div id="modalError" class="text-danger small mt-2"></div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Buchen</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
          </div>
        </form>
      </div>
    </div>
  `;
  document.body.appendChild(div);
  const bs = new bootstrap.Modal(div);
  bs.show();

  const form = div.querySelector('#bookingForm');
  const bookUser = div.querySelector('#bookUser');
  const bookStart = div.querySelector('#bookStart');
  const bookEnd = div.querySelector('#bookEnd');
  const modalError = div.querySelector('#modalError');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    modalError.textContent = '';
    const user = bookUser.value.trim() || currentUser;
    const start = bookStart.value;
    const end = bookEnd.value;
    if (!start || !end || start >= end) { modalError.textContent = 'Gültige Zeiten angeben (Start < Ende).'; return; }

    // Conflict check: only check seat conflicts (mobile is separate)
    if (roomId !== 'mobile') {
      const conflicting = allBookings.filter(b => b.date === date && b.roomId === roomId && b.seatId === seatId)
        .some(b => overlaps(timeToMinutes(start), timeToMinutes(end), timeToMinutes(b.startTime), timeToMinutes(b.endTime)));
      if (conflicting) { modalError.textContent = 'Konflikt: Zeitfenster überlappt mit bestehender Buchung.'; return; }
    }

    // Save booking
    try {
      await db.collection('bookings').add({
        date,
        roomId,
        seatId,
        startTime: start,
        endTime: end,
        user
      });
      bs.hide();
    } catch (err) {
      modalError.textContent = 'Fehler beim Speichern: ' + (err.message || err);
    }
  });

  div.addEventListener('hidden.bs.modal', () => div.remove());
}

/* ================== My bookings list ================== */
function renderMyBookings(){
  myBookingsList.innerHTML = '';
  const mine = allBookings.filter(b => b.user === currentUser)
    .sort((a,b) => a.date === b.date ? (a.startTime < b.startTime ? -1 : 1) : (a.date < b.date ? -1 : 1));
  if (mine.length === 0) {
    myBookingsList.innerHTML = '<li class="list-group-item">Keine Buchungen.</li>';
    return;
  }
  for (const b of mine){
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `<div><strong>${ROOMS.find(r=>r.id===b.roomId)?.label || b.roomId}</strong> ${b.seatId !== 'mobile' ? ', ' + b.seatId : ''}<br><small class="small-muted">${b.date} • ${b.startTime} - ${b.endTime}</small></div>`;
    const btn = document.createElement('button');
    btn.className = 'btn btn-sm btn-outline-danger';
    btn.textContent = 'Stornieren';
    btn.onclick = async () => {
      if (!confirm('Buchung stornieren?')) return;
      await db.collection('bookings').doc(b.id).delete();
    };
    li.appendChild(btn);
    myBookingsList.appendChild(li);
  }
}

/* initial render */
render();

</script>
</body>
</html>

